"""
ì‹¤ì‹œê°„ ì‹œê°í™” ëª¨ë“ˆ
ìµœì í™” ì§„í–‰ ê³¼ì •ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•˜ê³  ì‹œê°í™”í•©ë‹ˆë‹¤.
"""

import time
import matplotlib.pyplot as plt
import matplotlib.patches as patches
from matplotlib.animation import FuncAnimation
from typing import Dict, List, Any, Optional
import threading
import numpy as np


class RealtimeVisualizer:
    """ì‹¤ì‹œê°„ ìµœì í™” ì§„í–‰ ì‹œê°í™”ê¸°"""
    
    def __init__(self, site_width: int, site_height: int, update_interval: float = 2.0):
        """
        ì´ˆê¸°í™”
        
        Args:
            site_width: ë¶€ì§€ ë„ˆë¹„
            site_height: ë¶€ì§€ ë†’ì´
            update_interval: ì—…ë°ì´íŠ¸ ê°„ê²© (ì´ˆ)
        """
        self.site_width = site_width
        self.site_height = site_height
        self.update_interval = update_interval
        
        # ì‹œê°í™” ìƒíƒœ
        self.is_active = False
        self.current_layout = []
        self.progress_data = {
            'current': 0,
            'total': 0,
            'best_fitness': 0,
            'fitness_history': [],
            'start_time': None
        }
        
        # ìƒ‰ìƒ ë§¤í•‘
        self.process_colors = {
            'main': '#FF6B6B',      # ë¹¨ê°• ê³„ì—´ (ì£¼ê³µì •)
            'sub': '#4ECDC4',       # ì²­ë¡ ê³„ì—´ (ë¶€ê³µì •)
            'fixed': '#95A5A6'      # íšŒìƒ‰ (ê³ ì •êµ¬ì—­)
        }
        
        # matplotlib ì„¤ì •
        plt.ion()  # ëŒ€í™”í˜• ëª¨ë“œ í™œì„±í™”
        self.fig = None
        self.axes = None
        
        print(f"ğŸ“º ì‹¤ì‹œê°„ ì‹œê°í™”ê¸° ì´ˆê¸°í™”: {site_width}Ã—{site_height}mm")
    
    def start_optimization(self):
        """ìµœì í™” ì‹œê°í™” ì‹œì‘"""
        self.is_active = True
        self.progress_data['start_time'] = time.time()
        self.progress_data['fitness_history'] = []
        
        # ì‹œê°í™” ì°½ ì´ˆê¸°í™”
        self._setup_visualization()
        
        print("ğŸ“º ì‹¤ì‹œê°„ ì‹œê°í™” ì‹œì‘")
    
    def stop_optimization(self):
        """ìµœì í™” ì‹œê°í™” ì¢…ë£Œ"""
        self.is_active = False
        
        if self.fig:
            plt.close(self.fig)
        
        print("ğŸ“º ì‹¤ì‹œê°„ ì‹œê°í™” ì¢…ë£Œ")
    
    def update_progress(self, 
                       current: int, 
                       total: int, 
                       best_fitness: float, 
                       current_layout: List[Dict[str, Any]] = None):
        """
        ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
        
        Args:
            current: í˜„ì¬ ì§„í–‰ ìƒí™©
            total: ì „ì²´ ì‘ì—…ëŸ‰
            best_fitness: í˜„ì¬ ìµœê³  ì í•©ë„
            current_layout: í˜„ì¬ ë°°ì¹˜ (ì„ íƒì‚¬í•­)
        """
        if not self.is_active:
            return
        
        # ì§„í–‰ ë°ì´í„° ì—…ë°ì´íŠ¸
        self.progress_data['current'] = current
        self.progress_data['total'] = total
        self.progress_data['best_fitness'] = best_fitness
        self.progress_data['fitness_history'].append(best_fitness)
        
        if current_layout:
            self.current_layout = current_layout
        
        # ì‹œê°í™” ì—…ë°ì´íŠ¸
        self._update_visualization()
    
    def _setup_visualization(self):
        """ì‹œê°í™” ì°½ ì„¤ì •"""
        
        # ê·¸ë˜í”„ êµ¬ì„±: 2x2 ì„œë¸Œí”Œë¡¯
        self.fig, self.axes = plt.subplots(2, 2, figsize=(15, 10))
        self.fig.suptitle('ê³µì • ë°°ì¹˜ ìµœì í™” ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§', fontsize=16, fontweight='bold')
        
        # ì„œë¸Œí”Œë¡¯ ì œëª© ì„¤ì •
        self.axes[0, 0].set_title('í˜„ì¬ ìµœì  ë°°ì¹˜')
        self.axes[0, 1].set_title('ì í•©ë„ ì§„í™” ê³¼ì •')
        self.axes[1, 0].set_title('ì§„í–‰ë¥ ')
        self.axes[1, 1].set_title('ìµœì í™” í†µê³„')
        
        # ë°°ì¹˜ ì‹œê°í™” ì¶• ì„¤ì •
        self.axes[0, 0].set_xlim(0, self.site_width)
        self.axes[0, 0].set_ylim(0, self.site_height)
        self.axes[0, 0].set_aspect('equal')
        self.axes[0, 0].grid(True, alpha=0.3)
        self.axes[0, 0].set_xlabel('X (mm)')
        self.axes[0, 0].set_ylabel('Y (mm)')
        
        # ì í•©ë„ ê·¸ë˜í”„ ì¶• ì„¤ì •
        self.axes[0, 1].grid(True, alpha=0.3)
        self.axes[0, 1].set_xlabel('í‰ê°€ íšŸìˆ˜')
        self.axes[0, 1].set_ylabel('ì í•©ë„')
        
        plt.tight_layout()
        plt.show(block=False)
    
    def _update_visualization(self):
        """ì‹œê°í™” ì—…ë°ì´íŠ¸"""
        
        if not self.fig or not self.axes.any():
            return
        
        try:
            # 1. í˜„ì¬ ë°°ì¹˜ ì‹œê°í™”
            self._update_layout_plot()
            
            # 2. ì í•©ë„ ì§„í™” ê³¼ì •
            self._update_fitness_plot()
            
            # 3. ì§„í–‰ë¥  í‘œì‹œ
            self._update_progress_plot()
            
            # 4. í†µê³„ ì •ë³´
            self._update_statistics_plot()
            
            # í™”ë©´ ì—…ë°ì´íŠ¸
            self.fig.canvas.draw()
            self.fig.canvas.flush_events()
            
        except Exception as e:
            print(f"âš ï¸  ì‹œê°í™” ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: {str(e)}")
    
    def _update_layout_plot(self):
        """ë°°ì¹˜ ê·¸ë˜í”„ ì—…ë°ì´íŠ¸"""
        
        ax = self.axes[0, 0]
        ax.clear()
        ax.set_title('í˜„ì¬ ìµœì  ë°°ì¹˜')
        ax.set_xlim(0, self.site_width)
        ax.set_ylim(0, self.site_height)
        ax.set_aspect('equal')
        ax.grid(True, alpha=0.3)
        ax.set_xlabel('X (mm)')
        ax.set_ylabel('Y (mm)')
        
        # ë¶€ì§€ ê²½ê³„ í‘œì‹œ
        site_boundary = patches.Rectangle(
            (0, 0), self.site_width, self.site_height,
            linewidth=2, edgecolor='black', facecolor='none'
        )
        ax.add_patch(site_boundary)
        
        # ê³µì •ë“¤ í‘œì‹œ
        for rect in self.current_layout:
            building_type = rect.get('building_type', 'sub')
            color = self.process_colors.get(building_type, '#CCCCCC')
            
            # ì‚¬ê°í˜• ê·¸ë¦¬ê¸°
            rectangle = patches.Rectangle(
                (rect['x'], rect['y']), 
                rect['width'], 
                rect['height'],
                linewidth=1,
                edgecolor='black',
                facecolor=color,
                alpha=0.7
            )
            ax.add_patch(rectangle)
            
            # ë¼ë²¨ ì¶”ê°€
            center_x = rect['x'] + rect['width'] / 2
            center_y = rect['y'] + rect['height'] / 2
            
            # íšŒì „ í‘œì‹œ
            rotation_marker = " (R)" if rect.get('rotated', False) else ""
            label = f"{rect['id']}{rotation_marker}"
            
            ax.text(center_x, center_y, label, 
                   ha='center', va='center', 
                   fontsize=8, fontweight='bold',
                   bbox=dict(boxstyle="round,pad=0.1", facecolor='white', alpha=0.8))
        
        # ë²”ë¡€ ì¶”ê°€
        legend_elements = [
            patches.Patch(color=self.process_colors['main'], label='ì£¼ê³µì •'),
            patches.Patch(color=self.process_colors['sub'], label='ë¶€ê³µì •'),
            patches.Patch(color=self.process_colors['fixed'], label='ê³ ì •êµ¬ì—­')
        ]
        ax.legend(handles=legend_elements, loc='upper right')
    
    def _update_fitness_plot(self):
        """ì í•©ë„ ê·¸ë˜í”„ ì—…ë°ì´íŠ¸"""
        
        ax = self.axes[0, 1]
        ax.clear()
        ax.set_title('ì í•©ë„ ì§„í™” ê³¼ì •')
        ax.grid(True, alpha=0.3)
        ax.set_xlabel('í‰ê°€ íšŸìˆ˜')
        ax.set_ylabel('ì í•©ë„')
        
        if self.progress_data['fitness_history']:
            history = self.progress_data['fitness_history']
            x = range(1, len(history) + 1)
            
            ax.plot(x, history, 'b-', linewidth=2, alpha=0.7)
            ax.fill_between(x, history, alpha=0.3)
            
            # ìµœê³ ì  í‘œì‹œ
            max_fitness = max(history)
            max_index = history.index(max_fitness)
            ax.plot(max_index + 1, max_fitness, 'ro', markersize=8, label=f'ìµœê³ : {max_fitness:.1f}')
            
            # í˜„ì¬ì  í‘œì‹œ
            current_fitness = history[-1]
            ax.plot(len(history), current_fitness, 'go', markersize=6, label=f'í˜„ì¬: {current_fitness:.1f}')
            
            ax.legend()
    
    def _update_progress_plot(self):
        """ì§„í–‰ë¥  ê·¸ë˜í”„ ì—…ë°ì´íŠ¸"""
        
        ax = self.axes[1, 0]
        ax.clear()
        ax.set_title('ì§„í–‰ë¥ ')
        
        current = self.progress_data['current']
        total = self.progress_data['total']
        
        if total > 0:
            progress = current / total
            
            # ì§„í–‰ë¥  ë°”
            bars = ax.bar(['ì§„í–‰ë¥ '], [progress], color='green', alpha=0.7, width=0.5)
            ax.set_ylim(0, 1)
            ax.set_ylabel('ì™„ë£Œìœ¨')
            
            # í¼ì„¼íŠ¸ í‘œì‹œ
            ax.text(0, progress/2, f'{progress:.1%}', 
                   ha='center', va='center', fontsize=12, fontweight='bold')
            
            # ìˆ«ì í‘œì‹œ
            ax.text(0, progress + 0.05, f'{current}/{total}', 
                   ha='center', va='bottom', fontsize=10)
            
            # ì˜ˆìƒ ë‚¨ì€ ì‹œê°„ ê³„ì‚°
            if self.progress_data['start_time'] and progress > 0:
                elapsed = time.time() - self.progress_data['start_time']
                estimated_total = elapsed / progress
                remaining = estimated_total - elapsed
                
                ax.text(0, -0.15, f'ì†Œìš”: {elapsed:.0f}ì´ˆ | ì˜ˆìƒ ì”ì—¬: {remaining:.0f}ì´ˆ', 
                       ha='center', va='top', fontsize=9, transform=ax.transAxes)
    
    def _update_statistics_plot(self):
        """í†µê³„ ì •ë³´ ì—…ë°ì´íŠ¸"""
        
        ax = self.axes[1, 1]
        ax.clear()
        ax.set_title('ìµœì í™” í†µê³„')
        ax.axis('off')
        
        # í†µê³„ í…ìŠ¤íŠ¸ ìƒì„±
        stats_text = []
        
        # ê¸°ë³¸ ì •ë³´
        current = self.progress_data['current']
        total = self.progress_data['total']
        best_fitness = self.progress_data['best_fitness']
        
        stats_text.append(f"ğŸ“Š ì§„í–‰ ìƒí™©: {current}/{total}")
        stats_text.append(f"ğŸ† ìµœê³  ì í•©ë„: {best_fitness:.2f}")
        
        # ë°°ì¹˜ ì •ë³´
        if self.current_layout:
            main_count = len([r for r in self.current_layout if r.get('building_type') == 'main'])
            sub_count = len([r for r in self.current_layout if r.get('building_type') == 'sub'])
            stats_text.append(f"ğŸ­ ì£¼ê³µì •: {main_count}ê°œ")
            stats_text.append(f"ğŸ”§ ë¶€ê³µì •: {sub_count}ê°œ")
        
        # ì‹œê°„ ì •ë³´
        if self.progress_data['start_time']:
            elapsed = time.time() - self.progress_data['start_time']
            stats_text.append(f"â±ï¸ ì†Œìš”ì‹œê°„: {elapsed:.1f}ì´ˆ")
        
        # ì í•©ë„ í†µê³„
        if len(self.progress_data['fitness_history']) > 1:
            history = self.progress_data['fitness_history']
            avg_fitness = sum(history) / len(history)
            improvement = history[-1] - history[0] if history else 0
            
            stats_text.append(f"ğŸ“ˆ í‰ê·  ì í•©ë„: {avg_fitness:.2f}")
            stats_text.append(f"ğŸ“Š ì´ ê°œì„ ëŸ‰: {improvement:+.2f}")
        
        # í…ìŠ¤íŠ¸ í‘œì‹œ
        y_pos = 0.9
        for text in stats_text:
            ax.text(0.05, y_pos, text, transform=ax.transAxes, 
                   fontsize=11, verticalalignment='top')
            y_pos -= 0.12
    
    def capture_snapshot(self, filename: str = None) -> str:
        """í˜„ì¬ ìƒíƒœ ìŠ¤ëƒ…ìƒ· ì €ì¥"""
        
        if not filename:
            timestamp = time.strftime("%Y%m%d_%H%M%S")
            filename = f"optimization_snapshot_{timestamp}.png"
        
        if self.fig:
            try:
                self.fig.savefig(filename, dpi=150, bbox_inches='tight')
                print(f"ğŸ“¸ ìŠ¤ëƒ…ìƒ· ì €ì¥: {filename}")
                return filename
            except Exception as e:
                print(f"âŒ ìŠ¤ëƒ…ìƒ· ì €ì¥ ì‹¤íŒ¨: {str(e)}")
                return ""
        
        return ""
    
    def save_progress_data(self, filename: str = None) -> str:
        """ì§„í–‰ ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ ì €ì¥"""
        
        if not filename:
            timestamp = time.strftime("%Y%m%d_%H%M%S")
            filename = f"optimization_progress_{timestamp}.json"
        
        import json
        
        try:
            progress_data = self.progress_data.copy()
            progress_data['current_layout'] = self.current_layout
            progress_data['timestamp'] = time.time()
            
            # start_time ì§ë ¬í™”ë¥¼ ìœ„í•œ ë³€í™˜
            if progress_data['start_time']:
                progress_data['start_time'] = progress_data['start_time']
            
            with open(filename, 'w', encoding='utf-8') as f:
                json.dump(progress_data, f, indent=2, ensure_ascii=False, default=str)
            
            print(f"ğŸ’¾ ì§„í–‰ ë°ì´í„° ì €ì¥: {filename}")
            return filename
            
        except Exception as e:
            print(f"âŒ ì§„í–‰ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨: {str(e)}")
            return ""


class SimpleConsoleVisualizer:
    """ê°„ë‹¨í•œ ì½˜ì†” ê¸°ë°˜ ì‹œê°í™”ê¸° (GUI í™˜ê²½ì´ ì—†ëŠ” ê²½ìš°)"""
    
    def __init__(self, site_width: int, site_height: int):
        """
        ì´ˆê¸°í™”
        
        Args:
            site_width: ë¶€ì§€ ë„ˆë¹„
            site_height: ë¶€ì§€ ë†’ì´
        """
        self.site_width = site_width
        self.site_height = site_height
        self.is_active = False
        self.last_update = 0
        self.update_interval = 5.0  # 5ì´ˆ ê°„ê²©
        
        print(f"ğŸ–¥ï¸  ì½˜ì†” ì‹œê°í™”ê¸° ì´ˆê¸°í™”: {site_width}Ã—{site_height}mm")
    
    def start_optimization(self):
        """ìµœì í™” ì‹œì‘"""
        self.is_active = True
        self.last_update = 0
        print("ğŸ–¥ï¸  ì½˜ì†” ì‹œê°í™” ì‹œì‘")
        print("=" * 60)
    
    def stop_optimization(self):
        """ìµœì í™” ì¢…ë£Œ"""
        self.is_active = False
        print("=" * 60)
        print("ğŸ–¥ï¸  ì½˜ì†” ì‹œê°í™” ì¢…ë£Œ")
    
    def update_progress(self, 
                       current: int, 
                       total: int, 
                       best_fitness: float, 
                       current_layout: List[Dict[str, Any]] = None):
        """ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸"""
        
        if not self.is_active:
            return
        
        current_time = time.time()
        
        # ì—…ë°ì´íŠ¸ ê°„ê²© ì²´í¬
        if current_time - self.last_update < self.update_interval and current < total:
            return
        
        self.last_update = current_time
        
        # ì§„í–‰ë¥  ê³„ì‚°
        progress = (current / total * 100) if total > 0 else 0
        
        # ì§„í–‰ ë°” ìƒì„±
        bar_length = 30
        filled_length = int(bar_length * progress // 100)
        bar = 'â–ˆ' * filled_length + 'â–‘' * (bar_length - filled_length)
        
        # ìƒíƒœ ì¶œë ¥
        print(f"\rğŸ”„ ì§„í–‰ë¥ : |{bar}| {progress:.1f}% ({current}/{total}) "
              f"| ìµœê³  ì í•©ë„: {best_fitness:.2f}", end='', flush=True)
        
        if current >= total:
            print("\nâœ… ìµœì í™” ì™„ë£Œ!")
    
    def print_layout_summary(self, layout: List[Dict[str, Any]]):
        """ë°°ì¹˜ ìš”ì•½ ì •ë³´ ì¶œë ¥"""
        
        if not layout:
            return
        
        print(f"\nğŸ“‹ ë°°ì¹˜ ìš”ì•½:")
        print(f"   ì´ ê³µì • ìˆ˜: {len(layout)}ê°œ")
        
        # ê³µì • íƒ€ì…ë³„ ê°œìˆ˜
        main_count = len([r for r in layout if r.get('building_type') == 'main'])
        sub_count = len([r for r in layout if r.get('building_type') == 'sub'])
        print(f"   ì£¼ê³µì •: {main_count}ê°œ, ë¶€ê³µì •: {sub_count}ê°œ")
        
        # ë°°ì¹˜ ì˜ì—­
        if layout:
            min_x = min(r['x'] for r in layout)
            max_x = max(r['x'] + r['width'] for r in layout)
            min_y = min(r['y'] for r in layout)
            max_y = max(r['y'] + r['height'] for r in layout)
            
            layout_width = max_x - min_x
            layout_height = max_y - min_y
            
            print(f"   ë°°ì¹˜ ì˜ì—­: {layout_width}Ã—{layout_height}mm")
            print(f"   ë¶€ì§€ ë‚´ ìœ„ì¹˜: ({min_x}, {min_y}) ~ ({max_x}, {max_y})")


def create_visualizer(site_width: int, site_height: int, use_gui: bool = True):
    """
    í™˜ê²½ì— ë§ëŠ” ì‹œê°í™”ê¸° ìƒì„±
    
    Args:
        site_width: ë¶€ì§€ ë„ˆë¹„
        site_height: ë¶€ì§€ ë†’ì´
        use_gui: GUI ì‚¬ìš© ì—¬ë¶€
    
    Returns:
        ì ì ˆí•œ ì‹œê°í™”ê¸° ì¸ìŠ¤í„´ìŠ¤
    """
    
    if use_gui:
        try:
            # matplotlib ë°±ì—”ë“œ í™•ì¸
            import matplotlib
            backend = matplotlib.get_backend()
            
            if backend.lower() in ['agg', 'svg', 'pdf', 'ps']:
                print("âš ï¸  GUI ë°±ì—”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤. ì½˜ì†” ì‹œê°í™”ê¸°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.")
                return SimpleConsoleVisualizer(site_width, site_height)
            
            return RealtimeVisualizer(site_width, site_height)
            
        except ImportError:
            print("âš ï¸  matplotlibì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì½˜ì†” ì‹œê°í™”ê¸°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.")
            return SimpleConsoleVisualizer(site_width, site_height)
    
    else:
        return SimpleConsoleVisualizer(site_width, site_height)


if __name__ == "__main__":
    # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    print("ğŸ§ª RealtimeVisualizer í…ŒìŠ¤íŠ¸")
    
    # í…ŒìŠ¤íŠ¸ ë°ì´í„°
    site_width, site_height = 1000, 800
    
    test_layout = [
        {'id': 'A', 'x': 100, 'y': 100, 'width': 150, 'height': 100, 'building_type': 'main', 'rotated': False},
        {'id': 'B', 'x': 300, 'y': 150, 'width': 200, 'height': 120, 'building_type': 'main', 'rotated': True},
        {'id': 'C', 'x': 200, 'y': 300, 'width': 180, 'height': 90, 'building_type': 'main', 'rotated': False},
        {'id': 'W', 'x': 500, 'y': 200, 'width': 100, 'height': 80, 'building_type': 'sub', 'rotated': False},
    ]
    
    try:
        # GUI ì‹œê°í™”ê¸° í…ŒìŠ¤íŠ¸
        visualizer = RealtimeVisualizer(site_width, site_height)
        visualizer.start_optimization()
        
        # ê°€ìƒì˜ ìµœì í™” ê³¼ì • ì‹œë®¬ë ˆì´ì…˜
        for i in range(1, 21):
            fitness = 800 + i * 10 + np.random.normal(0, 5)  # ì ì§„ì  ê°œì„  + ë…¸ì´ì¦ˆ
            visualizer.update_progress(i, 20, fitness, test_layout)
            time.sleep(0.5)  # 0.5ì´ˆ ëŒ€ê¸°
        
        # ìŠ¤ëƒ…ìƒ· ì €ì¥
        snapshot_file = visualizer.capture_snapshot()
        
        # ì ì‹œ ëŒ€ê¸° í›„ ì¢…ë£Œ
        time.sleep(2)
        visualizer.stop_optimization()
        
        print("âœ… GUI ì‹œê°í™”ê¸° í…ŒìŠ¤íŠ¸ ì™„ë£Œ")
        
    except Exception as e:
        print(f"âš ï¸  GUI ì‹œê°í™”ê¸° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {str(e)}")
        print("ì½˜ì†” ì‹œê°í™”ê¸°ë¡œ ëŒ€ì²´ í…ŒìŠ¤íŠ¸")
        
        # ì½˜ì†” ì‹œê°í™”ê¸° í…ŒìŠ¤íŠ¸
        console_visualizer = SimpleConsoleVisualizer(site_width, site_height)
        console_visualizer.start_optimization()
        
        for i in range(1, 21):
            fitness = 800 + i * 10 + np.random.normal(0, 5)
            console_visualizer.update_progress(i, 20, fitness, test_layout)
            time.sleep(0.2)
        
        console_visualizer.print_layout_summary(test_layout)
        console_visualizer.stop_optimization()
        
        print("âœ… ì½˜ì†” ì‹œê°í™”ê¸° í…ŒìŠ¤íŠ¸ ì™„ë£Œ")